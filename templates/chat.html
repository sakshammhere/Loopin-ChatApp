<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loopin Chat</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{background:radial-gradient(circle at top left,#0f0f0f,#1a1a1a);color:#fff;height:100vh;display:flex;}
    .sidebar{width:280px;background:linear-gradient(180deg,#141414,#0c0c0c);display:flex;flex-direction:column;padding:1.25rem;border-right:1px solid rgba(255,255,255,.08);position:relative;}
    .top-logout{position:absolute;left:12px;top:10px;background:transparent;border:none;color:#a3a3a3;cursor:pointer;padding:.25rem .5rem;border-radius:8px;transition:.2s;}
    .top-logout:hover{color:#fff;text-shadow:0 0 10px #ec4899;}
    .user-section{text-align:left;padding-top:1.6rem;margin-bottom:1rem;}
    .username{font-size:1.6rem;font-weight:700;color:#fff;letter-spacing:.5px;}
    .nav{display:flex;gap:1rem;margin:.75rem 0 1.25rem;}
    .nav a{color:#8b5cf6;text-decoration:none;font-size:1rem;transition:.25s;cursor:pointer;}
    .nav a:hover{color:#c084fc;}
    .search-box{position:relative;}
    .search-box input{width:100%;padding:.8rem;border-radius:12px;background:#1e1e1e;border:none;color:#fff;outline:none;margin-bottom:1rem;transition:.3s;}
    .search-box input:focus{box-shadow:0 0 8px #8b5cf6;}
    .search-results{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:.6rem;position:absolute;top:55px;width:100%;max-height:240px;overflow-y:auto;z-index:30;}
    .search-result{display:flex;justify-content:space-between;align-items:center;background:#181818;border-radius:10px;padding:.5rem .7rem;margin-bottom:.4rem;transition:.2s;}
    .search-result:hover{background:#262626;}
    .search-result span{font-weight:500;}
    .search-result button{background:linear-gradient(90deg,#8b5cf6,#ec4899);border:none;color:#fff;padding:.35rem .7rem;border-radius:8px;cursor:pointer;font-size:.85rem;transition:.2s;}
    .search-result button:hover{opacity:.9;}
    .friends-list{flex-grow:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#8b5cf6 transparent;}
    .friend{padding:.9rem 1rem;margin-bottom:.5rem;border-radius:12px;background:#181818;transition:.25s;cursor:pointer;}
    .friend:hover{background:#262626;}
    .chat-area{flex-grow:1;display:flex;flex-direction:column;justify-content:space-between;background:radial-gradient(circle at center,#101010,#0a0a0a);padding:1rem 2rem;position:relative;overflow:hidden;}
    .chat-box{flex-grow:1;display:flex;flex-direction:column;justify-content:flex-end;overflow-y:auto;padding-bottom:1rem;}
    .chat-header{text-align:center;color:#ec4899;font-size:1.3rem;margin-bottom:.6rem;}
    .msg{max-width:70%;margin:.4rem;padding:.6rem .9rem;border-radius:12px;word-wrap:break-word;}
    .me{background:#8b5cf6;align-self:flex-end;}
    .them{background:#262626;align-self:flex-start;}
    .loopin-logo{position:absolute;top:1rem;left:50%;transform:translateX(-50%);font-size:1.8rem;font-weight:700;letter-spacing:2px;background:linear-gradient(90deg,#8b5cf6,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;cursor:pointer;animation:glow 2s infinite alternate;user-select:none;}
    @keyframes glow{from{text-shadow:0 0 10px #8b5cf6;}to{text-shadow:0 0 25px #ec4899;}}
    .animation-container{position:relative;width:300px;height:300px;margin:auto;}
    .boy{position:absolute;width:80px;height:80px;background:radial-gradient(circle at top,#8b5cf6,#1e1e1e);border-radius:50%;left:50%;top:50%;transform:translate(-50%,-50%);box-shadow:0 0 25px rgba(139,92,246,.8);animation:pulse 2.5s ease-in-out infinite;}
    @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);box-shadow:0 0 20px #8b5cf6;}50%{transform:translate(-50%,-50%) scale(1.1);box-shadow:0 0 40px #ec4899;}}
    .orbit{position:absolute;width:220px;height:220px;border:2px dashed rgba(255,255,255,.12);border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);animation:spin 10s linear infinite;}
    .orbit span{position:absolute;width:30px;height:30px;background:linear-gradient(135deg,#8b5cf6,#ec4899);border-radius:50%;box-shadow:0 0 10px #8b5cf6;animation:glowOrbit 2s infinite ease-in-out alternate;}
    @keyframes glowOrbit{from{box-shadow:0 0 10px #8b5cf6;transform:scale(1);}to{box-shadow:0 0 25px #ec4899;transform:scale(1.15);}}
    .orbit span:nth-child(1){top:0;left:50%;transform:translateX(-50%);}
    .orbit span:nth-child(2){bottom:0;left:50%;transform:translateX(-50%);}
    .orbit span:nth-child(3){left:0;top:50%;transform:translateY(-50%);}
    .orbit span:nth-child(4){right:0;top:50%;transform:translateY(-50%);}
    @keyframes spin{from{transform:translate(-50%,-50%) rotate(0deg);}to{transform:translate(-50%,-50%) rotate(360deg);}}
    .message-input{display:flex;margin-top:1rem;}
    .message-input input{flex-grow:1;padding:.8rem 1rem;border:none;border-radius:20px;outline:none;background:#1e1e1e;color:#fff;margin-right:.8rem;}
    .message-input button{padding:.8rem 1.5rem;border:none;border-radius:20px;background:linear-gradient(90deg,#8b5cf6,#ec4899);color:#fff;font-weight:600;cursor:pointer;transition:.25s;}
    .message-input button:hover{opacity:.9;transform:scale(1.04);}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50;}
    .modal{width:min(92vw,420px);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:1rem;box-shadow:0 10px 40px rgba(0,0,0,.5),inset 0 0 40px rgba(139,92,246,.08);animation:fadeIn .18s ease-out;}
    @keyframes fadeIn{from{transform:translateY(6px);opacity:0;}to{transform:translateY(0);opacity:1;}}
    .modal h3{font-size:1.1rem;font-weight:700;margin-bottom:.6rem;letter-spacing:.3px;}
    .modal .list{max-height:320px;overflow:auto;display:flex;flex-direction:column;gap:.5rem;}
    .chip{background:#181818;border:1px solid rgba(255,255,255,.06);padding:.75rem .9rem;border-radius:12px;display:flex;align-items:center;justify-content:space-between;}
    .chip .name{font-weight:500;}
    .row{display:flex;gap:.5rem;}
    .btn{border:none;padding:.55rem .9rem;border-radius:10px;cursor:pointer;font-weight:600;}
    .btn-primary{background:linear-gradient(90deg,#8b5cf6,#ec4899);color:#fff;}
    .btn-ghost{background:transparent;color:#e5e5e5;border:1px solid rgba(255,255,255,.12);}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:.75rem 0;}
    .input{width:100%;padding:.7rem .9rem;border-radius:12px;background:#121212;border:1px solid rgba(255,255,255,.08);color:#fff;outline:none;}
    .hint{font-size:.78rem;color:#a3a3a3;margin-top:.35rem;}
    .error{color:#fb7185;font-size:.82rem;margin-top:.35rem;display:none;}
    .hidden{display:none;}
  </style>
</head>
<body>
  <div class="sidebar">
    <button class="top-logout" id="btnLogoutTop">⟵ Logout</button>
    <div class="user-section">
      <div class="username" id="usernameDisplay">{{ user.username }}</div>
      <div class="nav">
        <a id="linkFriends">Friends</a>
        <a id="linkRequests">Requests</a>
        <a id="linkProfile">Profile</a>
      </div>
    </div>

    <div class="search-box">
      <input type="text" placeholder="Search friends..." id="searchInput"/>
      <div class="search-results hidden" id="searchResults"></div>
    </div>

    <div class="friends-list" id="friendsSidebar"></div>
  </div>

  <div class="chat-area">
    <div class="loopin-logo" id="loopinLogo">loopin</div>
    <div class="chat-box" id="chatBox">
      <div class="animation-container">
        <div class="boy"></div>
        <div class="orbit"><span></span><span></span><span></span><span></span></div>
      </div>
    </div>

    <div class="message-input">
      <input type="text" placeholder="Message..." id="msgInput" disabled />
      <button id="sendBtn" disabled>Send</button>
    </div>
  </div>

  <!-- Friends Modal -->
  <div class="backdrop" id="modalFriends">
    <div class="modal">
      <h3>Your Friends</h3>
      <div class="list" id="friendsList"></div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end;"><button class="btn btn-ghost" data-close>Close</button></div>
    </div>
  </div>

  <!-- Requests Modal -->
  <div class="backdrop" id="modalRequests">
    <div class="modal">
      <h3>Friend Requests</h3>
      <div class="list" id="requestsList"></div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end;"><button class="btn btn-ghost" data-close>Close</button></div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="backdrop" id="modalProfile">
    <div class="modal">
      <h3>Profile</h3>
      <label for="usernameInput" style="font-weight:600;font-size:.95rem;">Username</label>
      <input id="usernameInput" class="input" placeholder="Enter new username"/>
      <div class="hint">3–20 chars. Letters or letters+numbers. No symbols. Must contain at least one letter.</div>
      <div class="error" id="usernameError">Please use only letters or letters+numbers (3–20).</div>
      <div class="divider"></div>
      <div class="row" style="justify-content:space-between;">
        <button class="btn btn-ghost" data-close>Close</button>
        <div class="row">
          <button class="btn btn-ghost" id="btnLogoutInside">Logout</button>
          <button class="btn btn-primary" id="btnSaveUsername">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logout Modal -->
  <div class="backdrop" id="modalLogout">
    <div class="modal">
      <h3>Log out of Loopin?</h3>
      <div class="hint">You can always log back in later.</div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn btn-ghost" data-close>Cancel</button>
        <button class="btn btn-primary" id="btnDoLogout">Logout</button>
      </div>
    </div>
  </div>

<script>
document.getElementById('loopinLogo').addEventListener('click',()=>location.reload());
function openModal(id){document.getElementById(id).style.display='flex';}
function closeModal(el){el.closest('.backdrop').style.display='none';}
document.querySelectorAll('[data-close]').forEach(b=>b.onclick=e=>closeModal(e.target));

// --- Sidebar friends ---
async function refreshSidebar(){
  try{
    const r=await fetch("/api/friends/list");
    const d=await r.json();
    const list=document.getElementById("friendsSidebar");
    list.innerHTML="";
    if(!d.friends?.length){list.innerHTML="<div style='padding:1rem;color:#999;'>No friends yet</div>";return;}
    d.friends.forEach(f=>{
      const div=document.createElement("div");
      div.className="friend";
      div.textContent=f.username;
      div.onclick=()=>openChat(f.id,f.username);
      list.append(div);
    });
  }catch(e){console.log("sidebar",e);}
}
refreshSidebar();

// --- Search friends ---
const sInput=document.getElementById("searchInput"),sRes=document.getElementById("searchResults");
let timer;
sInput.addEventListener("input",()=>{
  const q=sInput.value.trim();
  clearTimeout(timer);
  if(!q){sRes.classList.add("hidden");sRes.innerHTML="";return;}
  timer=setTimeout(async()=>{
    const r=await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
    const d=await r.json();
    const users=d.users||[];
    sRes.classList.remove("hidden");
    sRes.innerHTML="";
    if(!users.length){sRes.innerHTML="<div class='search-result'><span>No users found</span></div>";return;}
    users.forEach(u=>{
      const div=document.createElement("div");
      div.className="search-result";
      const name=document.createElement("span");
      name.textContent=u.username;
      const add=document.createElement("button");
      add.textContent="Add Friend";
      add.onclick=async()=>{
        await fetch("/api/friends/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target_id:u.id})});
        add.textContent="Sent ✓";add.disabled=true;
      };
      const chat=document.createElement("button");
      chat.textContent="Chat";
      chat.style.background="#1e1e1e";chat.style.border="1px solid rgba(255,255,255,.2)";
      chat.onclick=()=>openChat(u.id,u.username);
      const act=document.createElement("div");
      act.style.display="flex";act.style.gap="6px";
      act.append(add,chat);
      div.append(name,act);
      sRes.append(div);
    });
  },300);
});
document.addEventListener("click",e=>{if(!sRes.contains(e.target)&&!sInput.contains(e.target))sRes.classList.add("hidden");});

// --- Requests modal ---
// Friends modal handler
document.getElementById("linkFriends").onclick=async()=>{
  const list=document.getElementById("friendsList");
  list.innerHTML="";
  const r=await fetch("/api/friends/list");
  const d=await r.json();
  const friends=d.friends||[];
  if(!friends.length){
    list.innerHTML="<div class='chip'><span>No friends added yet!</span></div>";
    openModal("modalFriends");
    return;
  }
  friends.forEach(f=>{
    const chip=document.createElement("div");
    chip.className="chip";
    chip.innerHTML=`<span>@${f.username}</span>`;
    const row=document.createElement("div");
    row.className="row";
    const chatBtn=document.createElement("button");
    chatBtn.className="btn btn-primary";
    chatBtn.textContent="Chat";
    chatBtn.onclick=()=>{
      closeModal(chatBtn);
      openChat(f.id, f.username);
    };
    row.append(chatBtn);
    chip.append(row);
    list.append(chip);
  });
  openModal("modalFriends");
};

// Requests modal handler
document.getElementById("linkRequests").onclick=async()=>{
  const list=document.getElementById("requestsList");list.innerHTML="";
  const r=await fetch("/api/requests");const d=await r.json();const req=d.requests||[];
  if(!req.length){list.innerHTML="<div class='chip'><span>No pending requests</span></div>";openModal("modalRequests");return;}
  req.forEach(o=>{
    const chip=document.createElement("div");chip.className="chip";chip.innerHTML=`<span>${o.username||o}</span>`;
    const row=document.createElement("div");row.className="row";
    const acc=document.createElement("button");acc.className="btn btn-primary";acc.textContent="Accept";
    acc.onclick=async()=>{await fetch("/api/requests/respond",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_id:o.id,action:"accept"})});chip.remove();refreshSidebar();};
    const dec=document.createElement("button");dec.className="btn btn-ghost";dec.textContent="Decline";
    dec.onclick=async()=>{await fetch("/api/requests/respond",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_id:o.id,action:"reject"})});chip.remove();};
    row.append(acc,dec);chip.append(row);list.append(chip);
  });
  openModal("modalRequests");
};

// --- Chat logic ---
let currentChatId=null;
async function openChat(id,username){
  currentChatId=id;
  const box=document.getElementById("chatBox");
  box.innerHTML=`<div class='chat-header'>Chat with ${username}</div>`;
  const r=await fetch(`/api/messages/${id}`);
  const d=await r.json();
  const msgs=d.messages||[];
  const myId = {{ user.id|tojson }};
  msgs.forEach(m=>{
    const div=document.createElement("div");
    div.className = "msg " + (m.sender_id === myId ? "me" : "them");
    div.textContent=m.content;
    box.append(div);
  });
  document.getElementById("msgInput").disabled=false;
  document.getElementById("sendBtn").disabled=false;
  box.scrollTop=box.scrollHeight;
}

// --- Send message ---
document.getElementById("sendBtn").onclick=async()=>{
  const input=document.getElementById("msgInput");
  const content=input.value.trim();
  if(!content||!currentChatId)return;
  const r=await fetch("/api/send_message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({friend_id:currentChatId,content})});
  const d=await r.json();
  if(d.success){
    const box=document.getElementById("chatBox");
    const div=document.createElement("div");
    div.className="msg me";
    div.textContent=content;
    box.append(div);
    box.scrollTop=box.scrollHeight;
    input.value="";
  }
};

// --- Logout ---
document.getElementById('btnLogoutTop').onclick=()=>openModal('modalLogout');
document.getElementById('btnLogoutInside').onclick=()=>openModal('modalLogout');
document.getElementById('btnDoLogout').onclick=async()=>{await fetch('/logout');location.href='/login';};
</script>
</body>
</html>
