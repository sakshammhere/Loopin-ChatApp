<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loopin Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
  <style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
body { height: 100vh; width: 100vw; background: #0b0b0b; color: #fff; display: flex; overflow: hidden; }

/* ---------- SIDEBAR ---------- */
.sidebar {
  width: 25%; min-width: 260px; background: #111;
  display: flex; flex-direction: column; border-right: 1px solid #222;
}
.top-logout { background: transparent; border: none; color: #aaa; cursor: pointer; padding: .6rem 1rem; text-align: left; transition: .2s; }
.top-logout:hover { color: #fff; }
.user-section { padding: 1rem; border-bottom: 1px solid #222; }
.username { font-size: 1.3rem; font-weight: 600; color: #fff; }
.nav { display: flex; gap: 1rem; margin-top: .6rem; }
.nav a { color: #8b5cf6; text-decoration: none; cursor: pointer; transition: .2s; }
.nav a:hover { color: #c084fc; }
.search-box { padding: 1rem; }
.search-box input { width: 100%; padding: .6rem .8rem; border: none; border-radius: 10px; background: #1e1e1e; color: #fff; outline: none; }
.friends-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #8b5cf6 transparent; }
.friend { padding: .9rem 1rem; border-bottom: 1px solid #222; cursor: pointer; transition: .2s; }
.friend:hover { background: #1e1e1e; }

/* ---------- CHAT AREA ---------- */
.chat-area { flex: 1; display: flex; flex-direction: column; position: relative; background: #0f0f0f; }
.loopin-logo {
  position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
  font-size: 1.6rem; font-weight: 700;
  background: linear-gradient(90deg,#8b5cf6,#ec4899);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: glow 2s infinite alternate; pointer-events: none;
}
@keyframes glow { from { text-shadow: 0 0 10px #8b5cf6; } to { text-shadow: 0 0 25px #ec4899; } }
.chat-topbar { height: 60px; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 0 1.2rem; background: #1a1a1a; border-bottom: 1px solid #222; }
.chat-peer { font-weight: 600; font-size: 1rem; color: #fff; }
.hidden { display: none !important; }

/* Messages area */
.chat-box { flex: 1; overflow-y: auto; padding: 1rem 1.5rem; display: flex; flex-direction: column; scroll-behavior: smooth; }
.msg { max-width: 70%; margin: .4rem 0; padding: .6rem 1rem; border-radius: 14px; word-wrap: break-word; }
.me { align-self: flex-end; background: linear-gradient(135deg,#8b5cf6,#ec4899); }
.them { align-self: flex-start; background: #262626; }

/* Input area */
.message-input { display: flex; align-items: center; padding: .8rem 1rem; background: #111; border-top: 1px solid #222; }
.message-input input { flex: 1; border: none; outline: none; background: #1e1e1e; color: #fff; padding: .7rem 1rem; border-radius: 20px; margin-right: .5rem; }
.icon-btn { background: transparent; border: none; color: #ccc; font-size: 1.3rem; cursor: pointer; margin-right: .3rem; }
.icon-btn:hover { color: #fff; }
.message-input button { border: none; border-radius: 20px; background: linear-gradient(90deg,#8b5cf6,#ec4899); color: #fff; padding: .7rem 1.4rem; font-weight: 600; cursor: pointer; transition: .2s; }
.message-input button:hover { transform: scale(1.05); }

/* Emoji palette */
.emoji-palette {
  position: absolute; bottom: 80px; left: 20px; z-index: 10;
  background: #141414; border: 1px solid rgba(255,255,255,.1);
  border-radius: 12px; padding: .5rem;
  display: grid; grid-template-columns: repeat(8, 1.5rem); gap: .3rem;
  box-shadow: 0 0 25px rgba(0,0,0,.6);
}

/* Idle animation */
.animation-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 300px; height: 300px; }
.boy {
  position: absolute; width: 80px; height: 80px;
  background: radial-gradient(circle at top,#8b5cf6,#1e1e1e);
  border-radius: 50%; left: 50%; top: 50%; transform: translate(-50%,-50%);
  box-shadow: 0 0 25px rgba(139,92,246,.8);
  animation: pulse 2.5s ease-in-out infinite;
}
@keyframes pulse {
  0%,100% { transform:translate(-50%,-50%) scale(1); box-shadow:0 0 20px #8b5cf6; }
  50% { transform:translate(-50%,-50%) scale(1.1); box-shadow:0 0 40px #ec4899; }
}
.orbit {
  position: absolute; width: 220px; height: 220px;
  border: 2px dashed rgba(255,255,255,.12);
  border-radius: 50%; top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  animation: spin 10s linear infinite;
}
.orbit span {
  position: absolute; width: 30px; height: 30px;
  background: linear-gradient(135deg,#8b5cf6,#ec4899);
  border-radius: 50%; box-shadow: 0 0 10px #8b5cf6;
}
.orbit span:nth-child(1){ top:0; left:50%; transform:translateX(-50%);}
.orbit span:nth-child(2){ bottom:0; left:50%; transform:translateX(-50%);}
.orbit span:nth-child(3){ left:0; top:50%; transform:translateY(-50%);}
.orbit span:nth-child(4){ right:0; top:50%; transform:translateY(-50%);}
@keyframes spin { from{transform:translate(-50%,-50%) rotate(0);} to{transform:translate(-50%,-50%) rotate(360deg);} }

/* ---------- MODALS ---------- */
.backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 50; }
.modal {
  width: min(92vw, 420px);
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 18px;
  padding: 1rem;
  box-shadow: 0 10px 40px rgba(0,0,0,.5), inset 0 0 40px rgba(139,92,246,.08);
  animation: fadeIn .18s ease-out;
}
@keyframes fadeIn { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <button class="top-logout" id="btnLogoutTop">⟵ Logout</button>
    <div class="user-section">
      <div class="username" id="usernameDisplay">{{ user.username }}</div>
      <div class="nav">
        <a id="linkFriends">Friends</a>
        <a id="linkRequests">Requests</a>
        <a id="linkProfile">Profile</a>
      </div>
    </div>

    <div class="search-box">
      <input type="text" placeholder="Search friends..." id="searchInput"/>
      <div class="search-results hidden" id="searchResults"></div>
    </div>

    <div class="friends-list" id="friendsSidebar"></div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area">
    <div class="loopin-logo" id="loopinLogo">loopin</div>
    <div class="chat-topbar">
      <div class="chat-peer" id="chatPeerName">Select a chat</div>
    </div>

    <div class="chat-box" id="chatBox">
      <div class="animation-container" id="idleAnimation">
        <div class="boy"></div>
        <div class="orbit"><span></span><span></span><span></span><span></span></div>
      </div>
    </div>

    <div class="message-input">
      <button class="icon-btn" id="emojiBtn" title="Emoji">😊</button>
      <input type="text" placeholder="Message..." id="msgInput" disabled />
      <button id="sendBtn" disabled>Send</button>
    </div>
    <div id="emojiPalette" class="emoji-palette hidden"></div>
  </div>

  <!-- Friends Modal -->
  <div class="backdrop" id="modalFriends">
    <div class="modal">
      <h3>Your Friends</h3>
      <div class="list" id="friendsList"></div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end;"><button class="btn btn-ghost" data-close>Close</button></div>
    </div>
  </div>

  <!-- Requests Modal -->
  <div class="backdrop" id="modalRequests">
    <div class="modal">
      <h3>Friend Requests</h3>
      <div class="list" id="requestsList"></div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end;"><button class="btn btn-ghost" data-close>Close</button></div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="backdrop" id="modalProfile">
    <div class="modal">
      <h3>Profile</h3>
      <div class="row gap mt" style="margin-bottom:10px;">
        <div class="chip">Friends: <span id="profileFriendsCount">0</span></div>
        <div class="chip">Loops: <span id="profileLoopsCount">0</span></div>
      </div>
      <label for="usernameInput" style="font-weight:600;font-size:.95rem;">Username</label>
      <input id="usernameInput" class="input" placeholder="Enter new username"/>
      <div class="hint">3–20 chars. Letters or letters+numbers. No symbols. Must contain at least one letter.</div>
      <div class="error" id="usernameError">Please use only letters or letters+numbers (3–20).</div>
      <div class="divider"></div>
      <div class="row" style="justify-content:space-between;">
        <button class="btn btn-ghost" data-close>Close</button>
        <div class="row">
          <button class="btn btn-ghost" id="btnLogoutInside">Logout</button>
          <button class="btn btn-primary" id="btnSaveUsername">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logout Modal -->
  <div class="backdrop" id="modalLogout">
    <div class="modal">
      <h3>Log out of Loopin?</h3>
      <div class="hint">You can always log back in later.</div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn btn-ghost" data-close>Cancel</button>
        <button class="btn btn-primary" id="btnDoLogout">Logout</button>
      </div>
    </div>
  </div>

<script>
document.getElementById('loopinLogo').addEventListener('click',()=>location.reload());
function openModal(id){document.getElementById(id).style.display='flex';}
function closeModal(el){el.closest('.backdrop').style.display='none';}
document.querySelectorAll('[data-close]').forEach(b=>b.onclick=e=>closeModal(e.target));

const myId = {{ user.id|tojson }};
let sendHandlerAttached = false;

// Profile modal
document.getElementById("linkProfile").onclick = async () => {
  try {
    const r = await fetch("/api/profile/stats");
    const d = await r.json();
    document.getElementById("profileFriendsCount").textContent = d.friends_count ?? "0";
    document.getElementById("profileLoopsCount").textContent = d.loops_count ?? "0";
    document.getElementById("usernameInput").value = d.username ?? "";
  } catch (e) {
    document.getElementById("profileFriendsCount").textContent = "-";
    document.getElementById("profileLoopsCount").textContent = "-";
  }
  openModal("modalProfile");
};

// Sidebar friends
async function refreshSidebar(){
  try{
    const r=await fetch("/api/friends/list");
    const d=await r.json();
    const list=document.getElementById("friendsSidebar");
    list.innerHTML="";
    if(!d.friends?.length){list.innerHTML="<div style='padding:1rem;color:#999;'>No friends yet</div>";return;}
    d.friends.forEach(f=>{
      const div=document.createElement("div");
      div.className="friend";
      div.textContent=f.username;
      div.onclick=()=>openChat(f.id,f.username);
      list.append(div);
    });
  }catch(e){console.log("sidebar",e);}
}
refreshSidebar();

// Search friends
const sInput=document.getElementById("searchInput"),sRes=document.getElementById("searchResults");
let timer;
sInput.addEventListener("input",()=>{
  const q=sInput.value.trim();
  clearTimeout(timer);
  if(!q){sRes.classList.add("hidden");sRes.innerHTML="";return;}
  timer=setTimeout(async()=>{
    const r=await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
    const d=await r.json();
    const users=d.users||[];
    sRes.classList.remove("hidden");
    sRes.innerHTML="";
    if(!users.length){sRes.innerHTML="<div class='search-result'><span>No users found</span></div>";return;}
    users.forEach(u=>{
      const div=document.createElement("div");
      div.className="search-result";
      const name=document.createElement("span");
      name.textContent=u.username;
      const add=document.createElement("button");
      add.textContent="Add Friend";
      add.onclick=async()=>{await fetch("/api/friends/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target_id:u.id})});add.textContent="Sent ✓";add.disabled=true;};
      const chat=document.createElement("button");
      chat.textContent="Chat";
      chat.style.background="#1e1e1e";chat.style.border="1px solid rgba(255,255,255,.2)";
      chat.onclick=()=>openChat(u.id,u.username);
      const act=document.createElement("div");
      act.style.display="flex";act.style.gap="6px";act.append(add,chat);
      div.append(name,act);sRes.append(div);
    });
  },300);
});
document.addEventListener("click",e=>{if(!sRes.contains(e.target)&&!sInput.contains(e.target))sRes.classList.add("hidden");});

// Friends modal
document.getElementById("linkFriends").onclick=async()=>{
  const list=document.getElementById("friendsList");list.innerHTML="";
  const r=await fetch("/api/friends/list");const d=await r.json();
  const friends=d.friends||[];
  if(!friends.length){list.innerHTML="<div class='chip'><span>No friends added yet!</span></div>";openModal("modalFriends");return;}
  friends.forEach(f=>{
    const chip=document.createElement("div");chip.className="chip";chip.innerHTML=`<span>@${f.username}</span>`;
    const row=document.createElement("div");row.className="row";
    const chatBtn=document.createElement("button");chatBtn.className="btn btn-primary";chatBtn.textContent="Chat";
    chatBtn.onclick=()=>{closeModal(chatBtn);openChat(f.id,f.username);};
    row.append(chatBtn);chip.append(row);list.append(chip);
  });openModal("modalFriends");
};

// Requests modal
document.getElementById("linkRequests").onclick=async()=>{
  const list=document.getElementById("requestsList");list.innerHTML="";
  const r=await fetch("/api/requests");const d=await r.json();const req=d.requests||[];
  if(!req.length){list.innerHTML="<div class='chip'><span>No pending requests</span></div>";openModal("modalRequests");return;}
  req.forEach(o=>{
    const chip=document.createElement("div");chip.className="chip";chip.innerHTML=`<span>${o.username||o}</span>`;
    const row=document.createElement("div");row.className="row";
    const acc=document.createElement("button");acc.className="btn btn-primary";acc.textContent="Accept";
    acc.onclick=async()=>{await fetch("/api/requests/respond",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_id:o.id,action:"accept"})});chip.remove();refreshSidebar();};
    const dec=document.createElement("button");dec.className="btn btn-ghost";dec.textContent="Decline";
    dec.onclick=async()=>{await fetch("/api/requests/respond",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_id:o.id,action:"reject"})});chip.remove();};
    row.append(acc,dec);chip.append(row);list.append(chip);
  });openModal("modalRequests");
};

// Chat logic
let currentThreadId = null, currentFriendId = null;

async function openChat(friendId, username){
  const chatPeer=document.getElementById("chatPeerName");
  const box=document.getElementById("chatBox");
  const idle=document.getElementById("idleAnimation");
  if(idle) idle.style.display="none";
  chatPeer.textContent=username;
  box.innerHTML="";
  const r=await fetch(`/api/messages?friend_id=${encodeURIComponent(friendId)}&limit=50`);
  const d=await r.json();
  const msgs=d.messages||[];
  currentFriendId=friendId;
  currentThreadId=msgs.length?msgs[0].thread_id:null;
  msgs.forEach(m=>{
    const div=document.createElement("div");
    div.className="msg "+(m.sender_id===myId?"me":"them");
    div.textContent=m.content;
    box.append(div);
  });
  document.getElementById("msgInput").disabled=false;
  document.getElementById("sendBtn").disabled=false;
  box.scrollTop=box.scrollHeight;
  if(!sendHandlerAttached){
    document.getElementById("sendBtn").onclick=sendMessage;
    document.getElementById("msgInput").addEventListener("keydown",e=>{
      if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}
    });
    sendHandlerAttached=true;
  }
  const sidebar=document.getElementById("friendsSidebar");
  const children=Array.from(sidebar.children);
  const idx=children.findIndex(div=>div.textContent===username);
  if(idx>0){const friendDiv=children[idx];sidebar.removeChild(friendDiv);sidebar.insertBefore(friendDiv,sidebar.firstChild);}
}

async function sendMessage(){
  const input=document.getElementById("msgInput");
  const content=input.value.trim();
  if(!content||(!currentThreadId&&!currentFriendId))return;
  const r=await fetch("/api/send_message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({thread_id:currentThreadId,friend_id:currentFriendId,content})});
  const d=await r.json();
  if(d.success){input.value="";if(d.message&&d.message.thread_id){currentThreadId=d.message.thread_id;}}
}

// Real-time updates
const es=new EventSource("/events");
es.onmessage=(ev)=>{
  try{
    const data=JSON.parse(ev.data);
    if(data.type==="message"){
      const m=data.row;
      if(m.thread_id&&m.thread_id===currentThreadId){
        const box=document.getElementById("chatBox");
        const div=document.createElement("div");
        div.className="msg "+(m.sender_id===myId?"me":"them");
        div.textContent=m.content;
        box.append(div);box.scrollTop=box.scrollHeight;
      }
    }
  }catch(e){console.log("EventSource error:",e);}
};

// Logout
document.getElementById('btnLogoutTop').onclick=()=>openModal('modalLogout');
document.getElementById('btnLogoutInside').onclick=()=>openModal('modalLogout');
document.getElementById('btnDoLogout').onclick=async()=>{await fetch('/logout');location.href='/login';};

// Emoji Picker
const emojiBtn=document.getElementById("emojiBtn");
const emojiPalette=document.getElementById("emojiPalette");
const msgInput=document.getElementById("msgInput");
const emojis=["😀","😅","😂","🤣","😊","😍","😘","😎","🤔","😇","😢","😭","😡","👍","👎","❤️","🔥","⭐","💀","😴","😱","🤩","🤖"];
emojiPalette.innerHTML=emojis.map(e=>`<button>${e}</button>`).join("");
emojiBtn.addEventListener("click",e=>{e.stopPropagation();emojiPalette.classList.toggle("hidden");});
emojiPalette.addEventListener("click",e=>{if(e.target.tagName==="BUTTON"){msgInput.value+=e.target.textContent;}});
document.addEventListener("click",e=>{if(!emojiPalette.contains(e.target)&&e.target!==emojiBtn){emojiPalette.classList.add("hidden");}});
</script>
</body>
</html>
